package com.cyberaudit.backend.entity;

import jakarta.persistence.*;
import lombok.Data;
import lombok.NoArgsConstructor;
import lombok.AllArgsConstructor;
import org.hibernate.annotations.CreationTimestamp;

import java.math.BigDecimal;
import java.time.LocalDateTime;

/**
 * Simple Explanation:
 * - When NMAP or ZAP finds a problem, we create a Vulnerability object
 * - This object stores: name, severity, description, risk score
 */
@Entity
@Table(name = "vulnerabilities")
@Data
@NoArgsConstructor
@AllArgsConstructor
public class Vulnerability {

    // PRIMARY KEY
    @Id // Marks this field as the primary key (unique identifier)
    @GeneratedValue(strategy = GenerationType.IDENTITY)
    private Long id;
    @ManyToOne(fetch = FetchType.LAZY) // Many vulnerabilities â†’ One scan
    @JoinColumn(name = "scan_id") // Creates column "scan_id" that links to scans table
    private Scan scan;

    // VULNERABILITY DETAILS
    /**
     * Name of the vulnerability
     */
    @Column(nullable = false)
    private String name;

    /**
     * How serious/dangerous this vulnerability is
     */
    @Column(nullable = false)
    private String severity;

    /**
     * Human-readable explanation of the vulnerability
     */
    @Column(columnDefinition = "TEXT") // TEXT type for long descriptions
    private String description;

    /**
     * Which security tool found this vulnerability
     */
    private String sourceTool;

    /**
     * AI-calculated risk score from 0.0 to 10.0
     * Examples: 3.2 (low risk), 7.8 (high risk), 9.5 (critical)
     * This will be populated by your AI model
     */
    @Column(precision = 3, scale = 1)
    private BigDecimal riskScore;

    // TIMESTAMP
    /**
     * When this vulnerability was detected
     * 
     * @CreationTimestamp automatically sets this to current time. This is done all
     *                    automatically by Java.
     */
    @CreationTimestamp
    @Column(updatable = false) // Once set, this field cannot be changed
    private LocalDateTime detectedAt;

    // CUSTOM CONSTRUCTORS
    /**
     * Constructor for creating vulnerabilities found by tools
     * Used when NMAP or ZAP finds a vulnerability
     * 
     * @param scan        The scan that found this vulnerability
     * @param name        Vulnerability name (e.g., "SQL Injection")
     * @param severity    Severity level ("LOW", "MEDIUM", "HIGH", "CRITICAL")
     * @param description Plain-English explanation
     * @param sourceTool  Which tool found it ("NMAP" or "ZAP")
     */
    public Vulnerability(Scan scan, String name, String severity, String description, String sourceTool) {
        this.scan = scan;
        this.name = name;
        this.severity = severity;
        this.description = description;
        this.sourceTool = sourceTool;
    }

    /**
     * Constructor with AI risk score included
     * Used after AI model has calculated the risk
     * 
     * @param scan        The scan that found this vulnerability
     * @param name        Vulnerability name
     * @param severity    Severity level
     * @param description Plain-English explanation
     * @param sourceTool  Which tool found it
     * @param riskScore   AI-calculated risk (0.0 to 10.0)
     */
    public Vulnerability(Scan scan, String name, String severity, String description,
            String sourceTool, BigDecimal riskScore) {
        this.scan = scan;
        this.name = name;
        this.severity = severity;
        this.description = description;
        this.sourceTool = sourceTool;
        this.riskScore = riskScore;
    }

    // HELPER METHODS
    /**
     * Check if this is a high-risk vulnerability
     */
    public boolean isHighRisk() {
        // Check severity
        if ("HIGH".equals(severity) || "CRITICAL".equals(severity)) {
            return true;
        }

        // Check AI risk score (if available)
        if (riskScore != null && riskScore.compareTo(BigDecimal.valueOf(7.0)) > 0) {
            return true;
        }

        return false;
    }

    /**
     * Get a simple risk category based on risk score
     */
    public String getRiskCategory() {
        if (riskScore == null) {
            // If no AI score, use severity
            return severity;
        }

        // Convert AI score to category
        double score = riskScore.doubleValue();
        if (score >= 9.0)
            return "CRITICAL";
        if (score >= 7.0)
            return "HIGH";
        if (score >= 4.0)
            return "MEDIUM";
        return "LOW";
    }

    /**
     * Get formatted risk score for display
     * 
     * @return Formatted string for UI display
     */
    public String getFormattedRiskScore() {
        if (riskScore == null) {
            return "Not Scored";
        }
        return riskScore.toString() + "/10.0";
    }

    /**
     * Override toString to prevent infinite loop with Scan relationship
     * 
     * @return String representation without the scan object
     */
    @Override
    public String toString() {
        return "Vulnerability{" +
                "id=" + id +
                ", name='" + name + '\'' +
                ", severity='" + severity + '\'' +
                ", sourceTool='" + sourceTool + '\'' +
                ", riskScore=" + riskScore +
                '}';
    }
}
