package com.cyberaudit.backend.repository;

import com.cyberaudit.backend.entity.Vulnerability;
import org.springframework.data.jpa.repository.JpaRepository;
import org.springframework.stereotype.Repository;

import java.math.BigDecimal;
import java.util.List;

/**
 * VulnerabilityRepository - Database access interface for Vulnerability
 * entities
 * 
 * This interface provides methods to interact with the "vulnerabilities" table.
 */
@Repository // Marks this as a repository component (Spring will manage it)
public interface VulnerabilityRepository extends JpaRepository<Vulnerability, Long> {

    // CUSTOM QUERY METHODS

    /**
     * Find all vulnerabilities for a specific scan
     */
    List<Vulnerability> findByScanId(Long scanId);

    /**
     * Find vulnerabilities by severity level
     */
    List<Vulnerability> findBySeverity(String severity);

    /**
     * Find vulnerabilities by the tool that found them
     */
    List<Vulnerability> findBySourceTool(String sourceTool);

    /**
     * Find vulnerabilities containing specific text in their name
     */
    List<Vulnerability> findByNameContaining(String name);

    /**
     * Find vulnerabilities for a scan, ordered by risk score (highest first)
     * Perfect for showing most dangerous issues first
     */
    List<Vulnerability> findByScanIdOrderByRiskScoreDesc(Long scanId);

    /**
     * Find vulnerabilities by severity and tool (combined conditions)
     */
    List<Vulnerability> findBySeverityAndSourceTool(String severity, String sourceTool);

    /**
     * Find vulnerabilities with risk score greater than a threshold
     */
    List<Vulnerability> findByRiskScoreGreaterThan(BigDecimal riskScore);

    /**
     * Find vulnerabilities with risk score between two values
     */
    List<Vulnerability> findByRiskScoreBetween(BigDecimal min, BigDecimal max);

    /**
     * Find vulnerabilities that haven't been scored by AI yet
     */
    List<Vulnerability> findByRiskScoreIsNull();

    /**
     * Find vulnerabilities that have been scored by AI
     */
    List<Vulnerability> findByRiskScoreIsNotNull();

    /**
     * Count vulnerabilities by severity
     * Useful for dashboard statistics
     */
    long countBySeverity(String severity);

    /**
     * Count vulnerabilities for a specific scan
     */
    long countByScanId(Long scanId);

    /**
     * Get all vulnerabilities ordered by risk score (highest first)
     * Shows most dangerous vulnerabilities across all scans
     */
    List<Vulnerability> findAllByOrderByRiskScoreDesc();

    // ====================================
    // ADVANCED: Custom Query Examples (Commented Out)
    // ====================================
    // Uncomment these if you need them later:

    /*
     * @Query("SELECT v FROM Vulnerability v WHERE v.severity IN ('HIGH', 'CRITICAL')"
     * )
     * List<Vulnerability> findAllHighRiskVulnerabilities();
     * 
     * @Query("SELECT v FROM Vulnerability v JOIN v.scan s WHERE s.targetUrl LIKE %:url%"
     * )
     * List<Vulnerability> findByTargetUrlContaining(@Param("url") String url);
     * 
     * @Query("SELECT v.severity, COUNT(v) FROM Vulnerability v GROUP BY v.severity"
     * )
     * List<Object[]> countBySeverityGrouped();
     */
}
